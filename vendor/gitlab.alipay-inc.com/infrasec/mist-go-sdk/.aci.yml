# Reference:
# https://yuque.antfin-inc.com/aci/aci-help/qczp6x
# https://yuque.antfin-inc.com/aci/aci-help/ccrifr

stages:
- 代码质量

environments:
  BUILD_IMAGE: "reg.docker.alibaba-inc.com/infrasec/golang-dev:1.13.8-20200311"
  PROJECT_NAME: "gitlab.alipay-inc.com/infrasec/mist-go-sdk"
  MIST_PATH: "/go/src/gitlab.alipay-inc.com/infrasec"
  MIST_PROJECT: "/go/src/${PROJECT_NAME}"

静态扫描:
  stage: 代码质量
  allowFailure: true
  plugin: CMD
  pluginConfig:
    encoding: UTF-8
    taskKind: CMD_GOLANGCI_LINT
  checkRule:
  - blocker = 0 && critical = 0

单元测试:
  stage: 代码质量
  aciTags: DOCKER
  agent:
    docker:
      image: ${BUILD_IMAGE}
  beforeScript:
    - env
    - mkdir -p ${MIST_PATH}
    - ln -sd ${WORKSPACE} ${MIST_PROJECT}
    - cd ${MIST_PROJECT}
  script:
    - |
      cd ${MIST_PROJECT}
      GO111MODULE=off make test
      echo test func-coverage $(tail -1 func.out | awk '{print $3}')
  coverage: '(?<=test func-coverage )\d+.\d+'
  publisher:
    archiveArtifacts: 'coverage.html'
  checkRule:
    coverage > 0
